<style>
	.numbin.traingame {
		height: 80px;
		font-size: 32px;
		min-width: 0;
	}
</style>

<div class="wrap marge1">
	<div class="full-width">
		<h1>Train Game</h1>
		<!-- SOLVE THE TRAIN START -->
		<div class="trainContainer">
			<!-- TRAINNNNN GAME -->

			<!-- functional parent for slots -->
			<div class="slots_container">
				<!-- cosmetic extra parent layer for slots -->
				<div class="numberSlots bg-2">
					<div class="numbin traingame" data-min="0" data-max="9" data-loop="true">
						<input type="number">
					</div>
					<div class="numbin traingame" data-min="0" data-max="9" data-loop="true">
						<input type="number">
					</div>
					<div class="numbin traingame" data-min="0" data-max="9" data-loop="true">
						<input type="number">
					</div>
					<div class="numbin traingame" data-min="0" data-max="9" data-loop="true">
						<input type="number">
					</div>
				</div>
			</div>

			<div class="test_display marge1" style="text-align: center;">
				____
			</div>

			<div class="buttonsDiv">
				<button class="toSolve" tabindex="1">Solve</button>
				<button class="toReset" tabindex="1">Reset</button>
			</div>

			<div>
				<div class="howToSolve"></div>

				<div class="solutions">
					<div class="trigger"><i class="fa-solid fa-caret-left hidden" id="leftTrig"></i></div>
					<div class="howManyGregs"></div>
					<div class="trigger"><i class="fa-solid fa-caret-right hidden" id="rightTrig"></i></div>
				</div>
			</div>

		</div>
		<!-- SOLVE THE TRAIN END -->
	</div>
</div>

<script>
	function getNumbersFromInputs(slots) {
		return Array.from(slots, slot => {
			const nb = slot.__numbinInstance;
			return nb ? nb.value : null; // nb.value already numeric or null
		});
	}

	function printSet() {
		const arr = getNumbersFromInputs(slots);
		// console.log(arr);
		let str = "";
		for (let i = 0; i < arr.length; i++) {
			if (arr[i] === null) {
                testDisplay.innerHTML = '____';
                return;
            };
			str += arr[i];
		}
		testDisplay.innerHTML = str;
	}

	function resetInputs() {
		// slots.forEach((slot) => {
		// 	const input = slot.querySelector('input');
		// 	input.value = '';
        //     numset[i] = null;
        //     printSet();
		// });

		for (let i = 0; i < slots.length; i++) {
			const input = slots[i].querySelector('input');
			input.value = '';
			numset[i] = null;
			printSet();
		}
	}


	const slots = document.querySelectorAll('.numbin.traingame');
	const testDisplay = document.querySelector('.test_display');
	const btn_toSolve = document.querySelector('.toSolve');
	const btn_toReset = document.querySelector('.toReset');
	btn_toSolve.onclick = () => printSet();
	btn_toReset.onclick = () => resetInputs();

	let numset = new Array(4).fill(null);


	document.addEventListener("DOMContentLoaded", () => {
		// numset = getNumbersFromInputs(slots);
		for (let i = 0; i < slots.length; i++) {
			const slot = slots[i];
			const input = slot.querySelector('input');
			input.setAttribute('inputmode', 'numeric');
			input.setAttribute('pattern', '[0-9]*');

			input.addEventListener('beforeinput', e => {
				if (e.isComposing) return;

				const t = e.inputType;
				if (t.startsWith('delete')) return; // allow deletes

				// only handle inserts
				if (!t.startsWith('insert')) return;

				const data = e.data ?? '';
				const digits = data.replace(/\D/g, '');
				if (digits.length === 0) {
					e.preventDefault(); // ignore letters or symbols
					return;
				}

				// decide what to keep
				let keep;
				if (t === 'insertFromPaste') {
					// paste: keep first numeric char
					keep = digits[0];
				} else {
					// normal typing or replacement: keep last numeric char
					keep = digits[digits.length - 1];
				}

				// override normal behaviour
				e.preventDefault();
				e.target.value = keep;
				e.target.dispatchEvent(
					new InputEvent("input", {
						bubbles: true,
						inputType: "insertText"
					})
				);
			});


			// rawdog the event here seeing as how we cut it off above
			input.addEventListener("input", e => {
				const value = parseInt(input.value);
				numset[i] = value;
				// console.log(numset);
				printSet();

				if (e.inputType === "insertText" && input.value !== "" && i < slots.length - 1) {
					const nextNb = slots[i + 1].__numbinInstance;
					if (nextNb && nextNb.value === null)
						setTimeout(() => nextNb.input.focus({
							preventScroll: true
						}), 0);
				}

			});
		}

	})


	window.addEventListener('load', () => {
		const slots = document.querySelectorAll('.numbin.traingame');
		for (const div of slots) {
			const nb = div.__numbinInstance;
			if (!nb) continue; // still safe if missing
			const input = nb.input;
			// input.addEventListener('beforeinput', clampToSingleDigit);
			console.log(input);
		}
	});
</script>